# based on https://github.com/actions/starter-workflows/blob/main/deployments/azure-staticwebapp.yml

name: Deploy tessiverse to Azure Static Web Apps

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  build_and_deploy:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    name: Build and Deploy
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: actions/setup-go@v5
        with: 
          go-version: 'stable'

      - uses: actions/setup-node@v4
        with: 
          node-version: '18'

      - name: Login via Azure CLI
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_RBAC_CREDENTIALS }}

      - name: Build
        run: |
             npm in --include=dev
             npm run build
             cd tq
             GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o ../build/server/bin/tq .

      - name: Deploy
        env: 
          SWA_CLI_DEPLOYMENT_TOKEN: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        run: |
            npx swa deploy production --env production

      - name: 'Deploy API as function app'
        uses: Azure/functions-action@v1
        id: fa
        with:
          app-name: "tessiverse-api"
          package: "./build/server"
